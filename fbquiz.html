<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèÜ FBQUIZ v0.9</title>
  <link rel="icon" href="cleip_milo.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Estilo de fondo coherente con index.html */
    body {
      background: url("fondodeaurasalanochecer.jpeg") no-repeat center center fixed;
      background-size: cover;
      opacity: 1; 
      transition: none;
    }
    
    .main-content-wrapper {
        opacity: 0;
        transition: opacity 1s ease-in-out;
    }
    
    .main-content-wrapper.show {
        opacity: 1;
    }
    
    /* --- Splash Screen --- */
    #splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
        opacity: 1;
        transition: opacity 1.5s ease;
    }
    #splash-screen img {
        width: 150px;
        border-radius: 50%;
        opacity: 1;
        transition: opacity 1s ease;
    }
    #splash-screen h1 {
        font-family: 'Orbitron', sans-serif;
        font-size: 3rem;
        color: white;
        opacity: 1;
        transition: opacity 1s ease;
        animation: blink 1s steps(1, end) 3;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    /* ... (resto de estilos) ... */

    @keyframes bounce-blue {
      0%, 100% {
        transform: translateY(0);
        text-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
      }
      50% {
        transform: translateY(-10px);
        text-shadow: 0 0 20px #3B82F6;
      }
    }
    .animate-bounce-blue { animation: bounce-blue 0.5s ease-in-out; }
    
    @keyframes incorrect-vibrate {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
    }
    .animate-incorrect-vibrate { animation: incorrect-vibrate 0.3s ease-in-out 3; }
    
    @keyframes correct-vibrate {
      0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
      25% { transform: scale(1.01); box-shadow: 0 0 20px #3B82F6; }
      50% { transform: scale(1); }
      75% { transform: scale(1.01); box-shadow: 0 0 20px #3B82F6; }
    }
    .animate-correct-vibrate { animation: correct-vibrate 0.2s ease-in-out; }

    @keyframes glow-expand {
      0% { box-shadow: 0 0 0 rgba(59, 130, 246, 0.4); transform: scale(1); }
      50% { box-shadow: 0 0 25px #3B82F6; transform: scale(1.05); }
      100% { box-shadow: 0 0 0 rgba(59, 130, 246, 0); transform: scale(1); }
    }
    .animate-glow-expand { animation: glow-expand 0.8s ease-out; }
    
    @keyframes streak-glow {
        0%, 100% { text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        50% { text-shadow: 0 0 30px #FBBF24; }
    }
    .animate-streak-glow { animation: streak-glow 0.5s infinite alternate; }
    
    /* --- Confetti --- */
    .confetti {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        pointer-events: none;
        z-index: 10;
    }
    .confetti-piece {
        position: absolute;
        width: 10px;
        height: 10px;
        opacity: 0;
        transform-origin: 50% 50%;
        animation: fall 3s infinite;
    }
    @keyframes fall {
        0% { opacity: 0; transform: translate(0, -100px) rotate(0deg); }
        10% { opacity: 1; }
        100% { opacity: 0; transform: translate(var(--x), 100vh) rotate(var(--r)); }
    }
    .confetti-blue { background-color: #3B82F6; }
    .confetti-white { background-color: #E5E7EB; }
    .confetti-yellow { background-color: #FBBF24; }
    
    /* --- CAMBIO v0.9: Estilos para Modo Fichas --- */
    #flashcard.is-flipped {
      transform: rotateY(180deg);
    }
    
  </style>
</head>
<body class="text-white font-sans flex flex-col min-h-screen">

  <div id="splash-screen">
    <img src="fabi_alancho_games.png" alt="Logo"> 
    <h1 id="splash-text">FBQUIZ</h1>
  </div>

  <div id="app-content-wrapper" class="main-content-wrapper flex flex-col min-h-screen">
      
      <header class="py-6 bg-black/50 text-center relative">
        <h1 id="header-title" class="text-3xl font-extrabold flex items-center justify-center cursor-pointer hover:opacity-80 transition-opacity">
          <span class="text-blue-500 text-5xl mr-2">üèÜ</span> FBQUIZ
        </h1>
        <span class="absolute top-2 right-4 text-sm text-gray-400 font-semibold">v0.9</span>
      </header>
    
      <div class="flex-grow flex items-center justify-center p-4">
        <main id="game-container" class="w-full max-w-3xl bg-gray-800/80 backdrop-blur-sm rounded-3xl shadow-2xl p-6 md:p-10 transition-all duration-500">
          
          <div id="input-screen">
              <h2 class="text-4xl font-extrabold text-center text-blue-400 mb-6">üìù Generador de Cuestionarios</h2>
              
              <div class="mb-4">
                <label for="separator-select" class="block text-sm font-medium text-gray-300 mb-2">
                    Elige el caracter separador (pregunta [SEP] respuesta):
                </label>
                <select id="separator-select" class="w-full p-3 text-gray-900 bg-white rounded-xl shadow-md focus:ring-4 focus:ring-blue-500 focus:outline-none text-xl">
                    <option value="|">| (Barra Vertical) - Recomendado</option>
                    <option value="-">- (Gui√≥n)</option>
                    <option value=",">, (Coma)</option>
                    <option value=".">. (Punto)</option>
                    <option value=">">> (Mayor que)</option>
                    <option value="<">< (Menor que)</option>
                    <option value="=">= (Igual)</option>
                </select>
              </div>
    
              <p class="text-lg text-gray-300 mb-4 text-center">Pega tu texto de estudio (en formato <code class="bg-gray-700 px-1 rounded">pregunta [SEP] respuesta</code>) para crear el quiz.</p>
              
              <textarea id="user-text" 
                        placeholder="Pega aqu√≠ tu texto. Cada l√≠nea debe ser:
    ¬øPregunta 1? | Respuesta 1
    ¬øPregunta 2? | Respuesta 2
    (Si pones m√°s separadores, se usar√°n como opciones para la Opci√≥n M√∫ltiple)" 
                        maxlength="10000"
                        class="w-full h-48 p-4 text-gray-900 bg-white rounded-xl shadow-md focus:ring-4 focus:ring-blue-500 focus:outline-none text-xl mb-6 resize-none"></textarea>
              
              <p id="char-count" class="text-right text-sm text-gray-400 mb-6">0 / 10000 caracteres</p>
    
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <button id="generate-button" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl text-2xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed">
                  Estudiar Ahora
                </button>
                <button id="flashcard-button" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl text-2xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-green-500/50 disabled:opacity-50 disabled:cursor-not-allowed">
                  üìö Modo Fichas
                </button>
                <button id="save-button" 
                        class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-xl text-2xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-amber-500/50 disabled:opacity-50 disabled:cursor-not-allowed">
                  üíæ Guardar
                </button>
              </div>
    
              <div id="loading-feedback" class="mt-4 text-center text-yellow-400 font-semibold hidden">
                  Cargando...
              </div>
              
              <hr class="border-gray-600 my-6">
              <h3 class="text-3xl font-extrabold text-center text-blue-400 mb-6">Mis Cuestionarios</h3>
              <div id="saved-quizzes-list" class="max-h-60 overflow-y-auto pr-2 space-y-3">
                  <p class="text-gray-400 text-center">No hay cuestionarios guardados.</p>
              </div>
          </div>
          
          <div id="quiz-screen" class="hidden">
              <div class="flex justify-between items-center mb-6">
                <div class="text-2xl font-bold">
                  Puntos: <span id="score" class="text-blue-400">0</span>
                </div>
                <div class="text-lg font-semibold">
                  Nivel: <span id="level" class="text-yellow-400">1</span>
                </div>
              </div>
              
              <div class="w-full bg-gray-700 rounded-full h-3 mb-8 shadow-inner">
                <div id="progress-bar" class="bg-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%; box-shadow: 0 0 5px #3B82F6;"></div>
              </div>
        
              <div id="question-area" class="text-center">
                <p class="text-lg text-gray-300 mb-2" id="question-prompt">Responde la pregunta:</p>
                <h2 id="question-word" class="text-4xl md:text-5xl font-extrabold text-white mb-6"></h2>
                
                <div id="streak-alert" class="text-3xl font-bold text-yellow-400 my-4 h-8 transition-all duration-300"></div>
        
                <input type="text" id="answer-input" placeholder="Escribe tu respuesta aqu√≠..." 
                       class="w-full p-4 text-gray-900 bg-white rounded-xl shadow-md focus:ring-4 focus:ring-blue-500 focus:outline-none text-center text-xl mb-6 transition-colors duration-300"
                       autocapitalize="off" autocomplete="off" autocorrect="off">
                
                <button id="check-button" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl text-2xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-blue-500/50">
                  Comprobar
                </button>
    
                <div id="answer-options" class="grid grid-cols-1 gap-3 hidden">
                    </div>
                
                <div id="feedback" class="mt-6 text-2xl font-bold min-h-[3rem]"></div>

                <div id="override-container" class="mt-6 space-y-3 md:space-y-0 md:space-x-4 flex flex-col md:flex-row justify-center hidden">
                  <button id="override-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl text-lg transition-transform transform active:scale-95">
                    Mi respuesta estaba bien
                  </button>
                  <button id="continue-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl text-lg transition-transform transform active:scale-95">
                    Ok, siguiente
                  </button>
                </div>
                </div>
          </div>
          
          <div id="finish-screen" class="hidden text-center">
            <h2 class="text-5xl font-extrabold text-blue-400 mb-8 animate-bounce-blue">üéâ ¬°Terminaste el cuestionario!</h2>
            <div class="space-y-4 text-xl">
              <p>Puntaje Total: <span id="final-score" class="text-blue-400 font-bold"></span></p>
              <p>Nivel Alcanzado: <span id="final-level" class="text-yellow-400 font-bold"></span></p>
              <p>Mejor Racha: <span id="final-streak" class="text-red-400 font-bold"></span></p>
              <p id="total-errors" class="text-red-300"></p>
            </div>
            <div class="mt-8 space-y-4 md:space-y-0 md:space-x-4 flex flex-col md:flex-row justify-center">
              <button id="retry-button" 
                      class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                üîÅ Volver a intentar
              </button>
              <button id="new-quiz-button"
                      class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-xl text-xl shadow-lg transition-all duration-200 transform hover:scale-105 mt-4 md:mt-0">
                ‚ûï Crear Nuevo Quiz
              </button>
              <a href="index.html" 
                 class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl text-xl shadow-lg transition-all duration-200 transform hover:scale-105 block text-center mt-4 md:mt-0">
                ‚¨Ö Volver al inicio
              </a>
            </div>
          </div>
          
          <div id="flashcard-screen" class="hidden text-center">
            <h2 class="text-4xl font-extrabold text-center text-green-400 mb-6">üìö Modo Fichas</h2>
            
            <div id="flashcard-container" class="relative w-full h-80 [perspective:1000px] mb-6">
              <div id="flashcard" class="relative w-full h-full cursor-pointer [transform-style:preserve-3d] transition-transform duration-700 ease-in-out">
                <div id="flashcard-front" class="absolute w-full h-full p-6 flex items-center justify-center bg-gray-700 rounded-2xl shadow-lg [backface-visibility:hidden]">
                  <p class="text-2xl md:text-3xl font-bold"></p>
                </div>
                <div id="flashcard-back" class="absolute w-full h-full p-6 flex items-center justify-center bg-blue-600 rounded-2xl shadow-lg [backface-visibility:hidden] [transform:rotateY(180deg)]">
                  <p class="text-2xl md:text-3xl"></p>
                </div>
              </div>
            </div>

            <div class="mt-8 flex justify-between items-center">
              <button id="fc-prev-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl text-xl shadow-lg transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                ‚¨Ö Anterior
              </button>
              <span id="fc-counter" class="text-2xl font-bold text-gray-300">1 / 10</span>
              <button id="fc-next-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl text-xl shadow-lg transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                Siguiente ‚û°
              </button>
            </div>
            <button id="fc-exit-button" class="w-full md:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl text-xl shadow-lg transition-all duration-200 transform hover:scale-105 mt-8">
              Salir del Modo Fichas
            </button>
          </div>
          </main>
      </div>
      
      <footer class="py-3 bg-black/50 text-center text-gray-500 text-sm">
          ¬©2025 created by fabialancho
      </footer>
  </div> <div id="confetti-container" class="confetti"></div>

  <script>
    // 1. Datos y Variables de Estado del Juego
    let QUESTIONS = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let level = 1;
    let currentStreak = 0;
    let bestStreak = 0;
    let totalQuestions = 0;
    let errorsInQuiz = 0;
    let questionsLeft = [];
    let currentQuestion;
    let currentQuizType = 'input'; // 'input', 'tf', 'mc'
    let currentFlashcardIndex = 0; // v0.9

    const INCORRECT_VIBRATE_CLASS = 'animate-incorrect-vibrate';
    const CORRECT_VIBRATE_CLASS = 'animate-correct-vibrate';
    const MC_ENABLED_AFTER = 0;
    const QUIZ_STORAGE_KEY = 'fbquiz-savedQuizzes';

    // 2. Referencias del DOM
    const inputScreen = document.getElementById('input-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const finishScreen = document.getElementById('finish-screen');
    const userTextarea = document.getElementById('user-text');
    const generateButton = document.getElementById('generate-button');
    const saveButton = document.getElementById('save-button');
    const loadingFeedback = document.getElementById('loading-feedback');
    const charCount = document.getElementById('char-count');
    const separatorSelect = document.getElementById('separator-select');
    const savedQuizzesList = document.getElementById('saved-quizzes-list');
    
    const questionWord = document.getElementById('question-word');
    const answerInput = document.getElementById('answer-input');
    const checkButton = document.getElementById('check-button');
    const feedback = document.getElementById('feedback');
    const scoreDisplay = document.getElementById('score');
    const levelDisplay = document.getElementById('level');
    const progressBar = document.getElementById('progress-bar');
    const streakAlert = document.getElementById('streak-alert');
    const gameContainer = document.getElementById('game-container');
    const retryButton = document.getElementById('retry-button');
    const newQuizButton = document.getElementById('new-quiz-button');
    const confettiContainer = document.getElementById('confetti-container');
    const questionPrompt = document.getElementById('question-prompt');
    const answerOptionsArea = document.getElementById('answer-options');
    
    const splashScreen = document.getElementById('splash-screen');
    const splashImg = splashScreen.querySelector('img');
    const splashText = splashScreen.querySelector('h1');
    const appContentWrapper = document.getElementById('app-content-wrapper');

    // CAMBIO v0.9: Nuevas referencias del DOM
    const headerTitle = document.getElementById('header-title');
    const overrideContainer = document.getElementById('override-container');
    const overrideButton = document.getElementById('override-button');
    const continueButton = document.getElementById('continue-button');
    
    const flashcardButton = document.getElementById('flashcard-button');
    const flashcardScreen = document.getElementById('flashcard-screen');
    const flashcardContainer = document.getElementById('flashcard-container');
    const flashcard = document.getElementById('flashcard');
    const flashcardFront = document.getElementById('flashcard-front').querySelector('p');
    const flashcardBack = document.getElementById('flashcard-back').querySelector('p');
    const fcPrevButton = document.getElementById('fc-prev-button');
    const fcNextButton = document.getElementById('fc-next-button');
    const fcCounter = document.getElementById('fc-counter');
    const fcExitButton = document.getElementById('fc-exit-button');
    

    // Funci√≥n de normalizaci√≥n
    const normalize = (text) => text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").trim();

    // 3. Funciones de Navegaci√≥n
    function showInputScreen() {
        inputScreen.classList.remove('hidden');
        quizScreen.classList.add('hidden');
        finishScreen.classList.add('hidden');
        flashcardScreen.classList.add('hidden'); // v0.9
        userTextarea.value = '';
        updateCharCount();
        renderSavedQuizzes();
        userTextarea.focus();
    }
    
    function showQuizScreen() {
        inputScreen.classList.add('hidden');
        quizScreen.classList.remove('hidden');
        finishScreen.classList.add('hidden');
        flashcardScreen.classList.add('hidden'); // v0.9
    }

    // 4. L√≥gica de Generaci√≥n y Parseo
    async function handleGenerateQuiz(mode = 'quiz') {
        const text = userTextarea.value.trim();
        if (text.length === 0) return;
        
        generateButton.disabled = true;
        saveButton.disabled = true;
        flashcardButton.disabled = true; // v0.9
        loadingFeedback.textContent = 'Generando...';
        loadingFeedback.classList.remove('hidden');
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        QUESTIONS = parseQuizText(text);
        totalQuestions = QUESTIONS.length;
        
        if (totalQuestions > 0) {
            if (mode === 'quiz') {
                startGame();
                showQuizScreen();
            } else if (mode === 'flashcards') {
                startFlashcards(); // v0.9
            }
        } else {
            loadingFeedback.textContent = `‚ùå Error. Aseg√∫rate de que el texto siga el formato: pregunta [${separatorSelect.value}] respuesta`;
            loadingFeedback.classList.remove('hidden');
            generateButton.disabled = false;
            saveButton.disabled = false;
            flashcardButton.disabled = false; // v0.9
            
            setTimeout(() => {
                loadingFeedback.classList.add('hidden');
                loadingFeedback.textContent = 'Cargando...';
            }, 3000);
            return;
        }
        
        loadingFeedback.classList.add('hidden');
    }

    function parseQuizText(text) {
        const separator = separatorSelect.value.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'); 
        const lines = text.split('\n').filter(line => line.trim() !== '');
        
        const separatorRegex = new RegExp(`\\s*${separator}\\s*`);
        
        return lines.map(line => {
            const parts = line.split(separatorRegex).map(p => p.trim()).filter(p => p.length > 0);
            
            if (parts.length >= 2) {
                const question = parts[0];
                const answer = parts[1];
                const options = parts.slice(1);
                
                return { 
                    question: question, 
                    answer: answer, 
                    options: options,
                    type: 'mixed'
                };
            }
            return null;
        }).filter(q => q !== null);
    }
    
    // 5. L√≥gica del Juego
    function startGame() {
        if (QUESTIONS.length === 0) return;

        currentQuestionIndex = 0;
        score = 0;
        level = 1;
        currentStreak = 0;
        bestStreak = 0;
        errorsInQuiz = 0;
        questionsLeft = [...QUESTIONS];
        questionsLeft.sort(() => Math.random() - 0.5);

        scoreDisplay.textContent = score;
        levelDisplay.textContent = level;
        progressBar.style.width = '0%';
        feedback.innerHTML = '';
        streakAlert.innerHTML = '';
        
        quizScreen.classList.remove('hidden');
        finishScreen.classList.add('hidden');
        flashcardScreen.classList.add('hidden');
        loadQuestion();
    }
    
    // CAMBIO v0.9: Nueva funci√≥n para avanzar de pregunta
    function proceedToNextQuestion() {
        currentQuestionIndex++;
        updateProgress();
        feedback.innerHTML = '';
        overrideContainer.classList.add('hidden'); // Ocultar botones
        loadQuestion();
    }
    
    function loadQuestion() {
        if (currentQuestionIndex >= totalQuestions) {
            finishGame();
            return;
        }
        currentQuestion = questionsLeft[currentQuestionIndex];
        const canDoMC = currentQuestionIndex >= MC_ENABLED_AFTER; 
        const rand = Math.random();
        currentQuizType = 'input';
        
        if (rand < 0.3 && canDoMC && currentQuestion.options.length > 1) {
            currentQuizType = 'mc';
        } else if (rand < 0.6) {
            currentQuizType = 'tf';
        } 
        
        renderQuestionUI(currentQuestion);
        
        questionWord.classList.remove('animate-bounce-blue');
        void questionWord.offsetWidth;
        questionWord.classList.add('animate-bounce-blue');
        
        if (currentQuizType === 'input') {
             answerInput.focus();
        }
    }
    
    function renderQuestionUI(q) {
        questionWord.textContent = q.question;
        answerInput.value = '';
        answerOptionsArea.innerHTML = '';
        
        answerInput.classList.add('hidden');
        checkButton.classList.add('hidden');
        answerOptionsArea.classList.add('hidden');
        answerInput.disabled = false;
        checkButton.disabled = false;
        answerOptionsArea.classList.remove('grid-cols-2');

        if (currentQuizType === 'input') {
            questionPrompt.textContent = 'Escribe la respuesta:';
            answerInput.classList.remove('hidden');
            checkButton.classList.remove('hidden');
        } else {
            answerOptionsArea.classList.remove('hidden');
            let optionsToRender = [];

            if (currentQuizType === 'tf') {
                questionPrompt.textContent = 'Verdadero o Falso:';
                const isStatementTrue = Math.random() < 0.5;
                let displayedAnswer;
                const correctNormalized = normalize(currentQuestion.answer);
                const otherAnswers = QUESTIONS.map(q => q.answer).filter(a => normalize(a) !== correctNormalized);
                
                if (isStatementTrue || otherAnswers.length === 0) {
                    displayedAnswer = currentQuestion.answer;
                    currentQuestion.tfCorrectAnswer = 'Verdadero';
                } else {
                    displayedAnswer = otherAnswers[Math.floor(Math.random() * otherAnswers.length)];
                    currentQuestion.tfCorrectAnswer = 'Falso';
                }
                
                questionWord.textContent = `¬øEs correcto que la respuesta a "${currentQuestion.question}" es: ${displayedAnswer}?`;

                optionsToRender = [{ text: 'Verdadero', value: 'Verdadero' }, { text: 'Falso', value: 'Falso' }];
                answerOptionsArea.classList.add('grid-cols-2'); 

            } else if (currentQuizType === 'mc') {
                questionPrompt.textContent = 'Selecciona la opci√≥n correcta:';
                const correctNormalized = normalize(currentQuestion.answer);
                let finalOptions = [...currentQuestion.options];
                const distractorPool = QUESTIONS.map(q => q.answer).filter(a => normalize(a) !== correctNormalized).sort(() => 0.5 - Math.random());
                
                let distractorCount = 0;
                while (finalOptions.length < 4 && distractorCount < distractorPool.length) {
                    const distractor = distractorPool[distractorCount];
                    if (!finalOptions.map(normalize).includes(normalize(distractor))) {
                        finalOptions.push(distractor);
                    }
                    distractorCount++;
                }
                finalOptions.sort(() => Math.random() - 0.5);
                optionsToRender = finalOptions.map(text => ({ text: text, value: text }));
                answerOptionsArea.classList.add('grid-cols-2'); 
            }

            optionsToRender.forEach((opt, index) => {
                const button = document.createElement('button');
                const label = ['A', 'B', 'C', 'D'][index] || '';
                button.textContent = `${label}. ${opt.text}`;
                button.dataset.value = opt.value;
                button.className = 'answer-option-button w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl text-lg shadow-md transition-all duration-150 mb-3 text-left';
                button.addEventListener('click', () => checkButtonAnswer(opt.value));
                answerOptionsArea.appendChild(button);
            });
        }
    }
    
    function checkAnswer() {
        if (answerInput.disabled) return;
        const userAnswer = normalize(answerInput.value);
        const correctAnswer = normalize(currentQuestion.answer);
        answerInput.disabled = true;
        checkButton.disabled = true;

        let isCorrect = (userAnswer === correctAnswer);

        if (!isCorrect && userAnswer.length > 0 && correctAnswer.length > 0) {
            if (correctAnswer.includes(userAnswer) && userAnswer.length >= correctAnswer.length * 0.5) {
                isCorrect = true;
            }
            if (!isCorrect && userAnswer.includes(correctAnswer) && correctAnswer.length >= userAnswer.length * 0.5) {
                isCorrect = true;
            }
        }
        
        if (isCorrect) {
            handleCorrectAnswer();
            // CAMBIO v0.9: Mover el avance a una funci√≥n separada
            setTimeout(proceedToNextQuestion, 1500);
        } else {
            handleIncorrectAnswer(currentQuestion.answer);
            // CAMBIO v0.9: Mostrar botones de anulaci√≥n y no avanzar autom√°ticamente
            overrideContainer.classList.remove('hidden');
        }
    }
    
    function checkButtonAnswer(userSelection) {
        document.querySelectorAll('.answer-option-button').forEach(btn => btn.disabled = true);
        let isCorrect = false;
        let correctAnswerText = '';

        if (currentQuizType === 'tf') {
            isCorrect = userSelection === currentQuestion.tfCorrectAnswer;
            correctAnswerText = currentQuestion.tfCorrectAnswer;
        } else if (currentQuizType === 'mc') {
            isCorrect = normalize(userSelection) === normalize(currentQuestion.answer);
            correctAnswerText = currentQuestion.answer;
        }

        document.querySelectorAll('.answer-option-button').forEach(btn => {
            const btnValue = btn.dataset.value;
            let isCorrectOption = (currentQuizType === 'tf') ? (btnValue === currentQuestion.tfCorrectAnswer) : (normalize(btnValue) === normalize(currentQuestion.answer));
            
            if (isCorrectOption) {
                 btn.classList.add('bg-green-600', 'ring-4', 'ring-green-400', 'animate-pulse');
            } else if (btnValue === userSelection && !isCorrect) {
                 btn.classList.add('bg-red-600', 'ring-4', 'ring-red-400');
            }
        });

        if (isCorrect) {
            handleCorrectAnswer();
            // CAMBIO v0.9: Mover el avance a una funci√≥n separada
            setTimeout(proceedToNextQuestion, 2500);
        } else {
            handleIncorrectAnswer(correctAnswerText);
            // CAMBIO v0.9: Mostrar botones de anulaci√≥n y no avanzar autom√°ticamente
            overrideContainer.classList.remove('hidden');
        }
    }

    function handleCorrectAnswer() {
        feedback.innerHTML = '‚úÖ <span class="text-green-400">¬°Correcto!</span>';
        feedback.classList.add('animate-bounce-blue');
        setTimeout(() => feedback.classList.remove('animate-bounce-blue'), 500);
        gameContainer.classList.add(CORRECT_VIBRATE_CLASS);
        setTimeout(() => gameContainer.classList.remove(CORRECT_VIBRATE_CLASS), 200);

        const previousLevel = level;
        score += 10;
        scoreDisplay.textContent = score;
        level = Math.floor(score / 50) + 1;
        
        if (level > previousLevel) { levelUp(); }
        levelDisplay.textContent = level;

        currentStreak++;
        bestStreak = Math.max(bestStreak, currentStreak);
        
        let retumboDuration = 0;
        if (currentStreak === 5) { showStreakAlert("üî• ¬°5 seguidas! (Retumbo)", true); retumboDuration = 500; } 
        else if (currentStreak === 10) { showStreakAlert("üí• ¬°10 seguidas! (Retumbo Fuerte)", true); retumboDuration = 800; } 
        else if (currentStreak > 10 && currentStreak % 5 === 0) { showStreakAlert(`‚ú® ¬°${currentStreak} seguidas!`); }
        
        if (retumboDuration > 0) {
             gameContainer.classList.add(CORRECT_VIBRATE_CLASS);
             setTimeout(() => gameContainer.classList.remove(CORRECT_VIBRATE_CLASS), retumboDuration);
        }
    }

    function handleIncorrectAnswer(correctAnswer) {
        errorsInQuiz++;
        feedback.innerHTML = `‚ùå <span class="text-red-400">Incorrecto. Era: ${correctAnswer}</span>`;
        gameContainer.classList.add(INCORRECT_VIBRATE_CLASS);
        setTimeout(() => gameContainer.classList.remove(INCORRECT_VIBRATE_CLASS), 900);
        currentStreak = 0;
        streakAlert.innerHTML = '';
    }

    // CAMBIO v0.9: Nueva funci√≥n para anular una respuesta incorrecta
    function handleOverrideAnswer() {
        // 1. Revertir estad√≠sticas incorrectas
        if (errorsInQuiz > 0) {
            errorsInQuiz--;
        }
        
        // 2. Aplicar estad√≠sticas correctas
        handleCorrectAnswer(); 
        
        // 3. Ocultar los botones de anulaci√≥n
        overrideContainer.classList.add('hidden');
        
        // 4. Establecer temporizador para avanzar
        setTimeout(proceedToNextQuestion, 1500);
    }

    function showStreakAlert(text, intense = false) {
        streakAlert.textContent = text;
        streakAlert.classList.remove('animate-streak-glow');
        void streakAlert.offsetWidth;
        if (intense) {
            streakAlert.classList.add('animate-streak-glow');
            spawnConfetti(50, ['confetti-yellow', 'confetti-white']);
        }
    }

    function updateProgress() {
        const progress = (currentQuestionIndex / totalQuestions) * 100;
        progressBar.style.width = `${progress}%`;
        if (progress >= 100) {
            progressBar.style.boxShadow = '0 0 10px #3B82F6, 0 0 20px rgba(59, 130, 246, 0.8)';
        } else {
            progressBar.style.boxShadow = '0 0 5px #3B82F6';
        }
    }

    function levelUp() {
        levelDisplay.classList.add('animate-glow-expand');
        spawnConfetti(30, ['confetti-blue', 'confetti-white']);
        setTimeout(() => levelDisplay.classList.remove('animate-glow-expand'), 800);
    }

    function finishGame() {
        quizScreen.classList.add('hidden');
        finishScreen.classList.remove('hidden');
        flashcardScreen.classList.add('hidden'); // v0.9
        
        document.getElementById('final-score').textContent = score;
        document.getElementById('final-level').textContent = level;
        document.getElementById('final-streak').textContent = bestStreak;
        document.getElementById('total-errors').textContent = `Errores cometidos: ${errorsInQuiz}`;
        
        const perfectText = document.querySelector('#finish-screen h2');
        if (errorsInQuiz === 0) {
            perfectText.textContent = "üåü ¬°PERFECTO!";
            perfectText.classList.remove('text-blue-400');
            perfectText.classList.add('text-yellow-400', 'animate-streak-glow');
            spawnConfetti(100, ['confetti-blue', 'confetti-yellow', 'confetti-white']);
        } else {
            perfectText.textContent = "üéâ ¬°Terminaste el cuestionario!";
            perfectText.classList.add('text-blue-400');
            perfectText.classList.remove('text-yellow-400', 'animate-streak-glow');
            spawnConfetti(50, ['confetti-blue']);
        }
    }
    
    function spawnConfetti(count, colors) {
        confettiContainer.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const piece = document.createElement('div');
            piece.className = 'confetti-piece ' + colors[Math.floor(Math.random() * colors.length)];
            piece.style.left = Math.random() * 100 + 'vw';
            piece.style.animationDelay = - (Math.random() * 2) + 's';
            piece.style.setProperty('--x', (Math.random() * 200 - 100) + 'px');
            piece.style.setProperty('--r', (Math.random() * 360) + 'deg');
            confettiContainer.appendChild(piece);
        }
        setTimeout(() => confettiContainer.innerHTML = '', 3000);
    }
    
    function updateCharCount() {
        const currentLength = userTextarea.value.length;
        const maxLength = userTextarea.maxLength;
        charCount.textContent = `${currentLength} / ${maxLength} caracteres`;
        
        const isEmpty = currentLength === 0;
        generateButton.disabled = isEmpty;
        saveButton.disabled = isEmpty;
        flashcardButton.disabled = isEmpty; // v0.9
    }

    // --- FUNCIONES DE LOCALSTORAGE
    function getQuizzes() {
        const quizzes = localStorage.getItem(QUIZ_STORAGE_KEY);
        return quizzes ? JSON.parse(quizzes) : {};
    }

    function saveQuizzes(quizzes) {
        localStorage.setItem(QUIZ_STORAGE_KEY, JSON.stringify(quizzes));
    }

    function renderSavedQuizzes() {
        savedQuizzesList.innerHTML = '';
        const quizzes = getQuizzes();
        const quizNames = Object.keys(quizzes);

        if (quizNames.length === 0) {
            savedQuizzesList.innerHTML = '<p class="text-gray-400 text-center">No hay cuestionarios guardados.</p>';
            return;
        }

        quizNames.forEach(name => {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-xl shadow-md';

            const nameSpan = document.createElement('span');
            nameSpan.textContent = name;
            nameSpan.className = 'font-semibold text-lg cursor-pointer hover:text-blue-300 transition-colors flex-1 truncate pr-4';
            nameSpan.title = `Cargar "${name}"`;
            nameSpan.onclick = () => loadQuizText(name);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Borrar';
            deleteBtn.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition-transform transform active:scale-95';
            deleteBtn.title = `Borrar "${name}"`;
            deleteBtn.onclick = () => deleteQuiz(name);

            item.appendChild(nameSpan);
            item.appendChild(deleteBtn);
            savedQuizzesList.appendChild(item);
        });
    }

    function handleSaveQuiz() {
        const text = userTextarea.value.trim();
        if (text.length === 0) {
            alert('No puedes guardar un cuestionario vac√≠o.');
            return;
        }

        let name = prompt('Dale un nombre a tu cuestionario (max 20 caracteres):');
        
        if (!name) return;
        
        name = name.trim().slice(0, 20);
        
        if (name.length === 0) {
             alert('El nombre no puede estar vac√≠o.');
             return;
        }

        const quizzes = getQuizzes();
        
        if (quizzes[name] && !confirm(`Ya existe un quiz con el nombre "${name}". ¬øQuieres sobrescribirlo?`)) {
            return;
        }

        quizzes[name] = text;
        saveQuizzes(quizzes);
        renderSavedQuizzes();
        
        alert(`¬°Cuestionario "${name}" guardado!`);
    }

    function loadQuizText(name) {
        const quizzes = getQuizzes();
        if (quizzes[name]) {
            userTextarea.value = quizzes[name];
            updateCharCount();
            window.scrollTo(0, 0);
        }
    }

    function deleteQuiz(name) {
        if (!confirm(`¬øEst√°s seguro de que quieres borrar el cuestionario "${name}"? Esta acci√≥n no se puede deshacer.`)) {
            return;
        }

        const quizzes = getQuizzes();
        delete quizzes[name];
        saveQuizzes(quizzes);
        renderSavedQuizzes();
    }

    // --- CAMBIO v0.9: L√≥gica del Modo Fichas ---
    function handleFlashcardMode() {
        handleGenerateQuiz('flashcards');
    }
    
    function startFlashcards() {
        currentFlashcardIndex = 0;
        totalQuestions = QUESTIONS.length;
        
        inputScreen.classList.add('hidden');
        quizScreen.classList.add('hidden');
        finishScreen.classList.add('hidden');
        flashcardScreen.classList.remove('hidden');
        
        loadFlashcard(currentFlashcardIndex);
    }
    
    function loadFlashcard(index) {
        if (index < 0 || index >= totalQuestions) return;
        
        const q = QUESTIONS[index];
        flashcardFront.textContent = q.question;
        flashcardBack.textContent = q.answer;
        fcCounter.textContent = `${index + 1} / ${totalQuestions}`;
        
        // Resetear la rotaci√≥n de la ficha
        flashcard.classList.remove('is-flipped');
        
        // Habilitar/deshabilitar botones de navegaci√≥n
        fcPrevButton.disabled = (index === 0);
        fcNextButton.disabled = (index === totalQuestions - 1);
    }
    // --- FIN CAMBIO v0.9 ---


    // 6. Manejadores de Eventos
    checkButton.addEventListener('click', checkAnswer);
    answerInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !answerInput.disabled && !quizScreen.classList.contains('hidden')) {
            checkAnswer();
        }
    });
    retryButton.addEventListener('click', startGame);
    newQuizButton.addEventListener('click', showInputScreen);
    generateButton.addEventListener('click', () => handleGenerateQuiz('quiz'));
    saveButton.addEventListener('click', handleSaveQuiz);
    userTextarea.addEventListener('input', updateCharCount);

    // --- CAMBIO v0.9: Nuevos Manejadores de Eventos ---
    headerTitle.addEventListener('click', () => {
        if (confirm('¬øQuieres recargar la p√°gina y volver al inicio? ¬øEst√°s seguro?')) {
            location.reload();
        }
    });
    
    continueButton.addEventListener('click', proceedToNextQuestion);
    overrideButton.addEventListener('click', handleOverrideAnswer);
    
    flashcardButton.addEventListener('click', handleFlashcardMode);
    flashcard.addEventListener('click', () => {
        flashcard.classList.toggle('is-flipped');
    });
    
    fcPrevButton.addEventListener('click', () => {
        if (currentFlashcardIndex > 0) {
            currentFlashcardIndex--;
            loadFlashcard(currentFlashcardIndex);
        }
    });
    
    fcNextButton.addEventListener('click', () => {
        if (currentFlashcardIndex < totalQuestions - 1) {
            currentFlashcardIndex++;
            loadFlashcard(currentFlashcardIndex);
        }
    });
    
    fcExitButton.addEventListener('click', showInputScreen);
    // --- FIN CAMBIO v0.9 ---


    // 7. Inicio del Flujo
    window.onload = () => {
        // 1. Espera 3 segundos para el parpadeo
        setTimeout(() => {
            // 2. Desvanece el logo y el texto
            splashImg.style.opacity = '0';
            splashText.style.opacity = '0';
            
            // 3. Espera 1s y desvanece el fondo negro
            setTimeout(() => {
                splashScreen.style.opacity = '0';
                
                // Muestra el contenido principal
                appContentWrapper.classList.add('show');
                
                // 4. Espera 1.5s y elimina el splash
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    showInputScreen();
                }, 1500);
            }, 1000);
        }, 3000);
    };
  </script>

</body>
</html>