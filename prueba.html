<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¡CLEIP ESCAPA! Demo</title>
    <style>
        @font-face {
            font-family: 'PixelatedFont';
            src: url('fuente_8bit.ttf') format('truetype');
        }

        body {
            font-family: 'PixelatedFont', sans-serif;
            background-color: #0d0d0d;
            color: #ffffff;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            text-align: center;
        }

        #game-container {
            position: relative;
            max-width: 100%; /* Permite que el contenedor se adapte */
            max-height: 100vh;
            display: none;
            flex-grow: 1; /* Permite que ocupe espacio disponible */
            display: flex; /* Añadido para centrar el canvas */
            justify-content: center;
            align-items: center;
        }

        #game-canvas {
            border: 2px solid #ffffff;
            background-color: #1a1a1a;
            max-width: 95vw; /* Usa el ancho de la ventana */
            max-height: 80vh; /* Usa la altura de la ventana */
            display: none;
        }

        .screen {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
            background-color: #1a1a1a;
            font-size: 1em; /* Tamaño de fuente base adaptable */
        }
        
        #start-screen {
            display: flex;
        }

        #logo {
            width: 250px;
            height: auto;
            margin-bottom: 20px;
            z-index: 2;
        }

        h2 {
            font-size: 2em;
            color: #ffcc00;
            z-index: 2;
        }

        .game-button {
            background-color: transparent;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.5em;
            cursor: pointer;
            transition: border-color 0.3s ease, color 0.3s ease;
            margin-top: 20px;
            font-family: 'PixelatedFont', sans-serif;
            z-index: 2;
            width: fit-content;
            text-align: center;
        }
        
        .game-button:hover {
            border-color: #00bfff;
            color: #00bfff;
        }

        #end-screen {
            display: none;
            background-color: rgba(0, 0, 0, 0.7);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        #end-screen h3 {
            font-size: 2.5em;
            color: #fff;
            margin-bottom: 20px;
        }

        #end-screen button {
            margin: 10px;
        }

        #pause-screen {
            display: none;
            background-color: rgba(0, 0, 0, 0.7);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #tutorial {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #fff;
            padding: 20px;
            border-radius: 10px;
            z-index: 5;
            font-size: 1.5em;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #tutorial-text {
            margin-bottom: 20px;
        }

        #tutorial-ok-btn {
            padding: 10px 20px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>

<audio id="background-music" loop>
    <source src="cleip_escapa_soundtrack.mp3" type="audio/mpeg">
</audio>

<div id="start-screen" class="screen">
    <canvas id="start-background-canvas" style="position: absolute; top: 0; left: 0; z-index: 1;"></canvas>
    <img id="logo" src="fabi_alancho_games.png" alt="Fabian Alancho Games Logo">
    <h2>¡CLEIP ESCAPA!</h2>
    <button id="play-button" class="game-button">JUGAR</button>
    <button id="music-toggle-button" class="game-button">MÚSICA: OFF</button>
</div>

<div id="game-container">
    <canvas id="game-canvas"></canvas>
    
    <div id="tutorial">
        <span id="tutorial-text">Usa WASD para moverte y 'P' para pausar. Sobrevive 60 segundos evitando al enemigo. ¡Buena suerte!</span>
        <button id="tutorial-ok-btn" class="game-button">OK</button>
    </div>
    
    <div id="pause-screen">
        <h3 class="text-4xl font-bold mb-8">PAUSA</h3>
        <button id="resume-button" class="game-button">REANUDAR</button>
        <button id="exit-pause-button" class="game-button">SALIR AL MENÚ</button>
    </div>
</div>

<div id="end-screen" class="screen">
    <h3 id="end-message"></h3>
    <button id="end-play-again-button" class="game-button">VOLVER A JUGAR</button>
    <button id="end-exit-button" class="game-button">SALIR AL MENÚ</button>
</div>

<script>
    const startScreen = document.getElementById('start-screen');
    const endScreen = document.getElementById('end-screen');
    const pauseScreen = document.getElementById('pause-screen');
    const playButton = document.getElementById('play-button');
    const endPlayAgainButton = document.getElementById('end-play-again-button');
    const endExitButton = document.getElementById('end-exit-button');
    const resumeButton = document.getElementById('resume-button');
    const exitPauseButton = document.getElementById('exit-pause-button');
    const musicToggleButton = document.getElementById('music-toggle-button');
    const music = document.getElementById('background-music');
    const gameContainer = document.getElementById('game-container');
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const tutorialMessage = document.getElementById('tutorial');
    const tutorialOkButton = document.getElementById('tutorial-ok-btn');

    const startBgCanvas = document.getElementById('start-background-canvas');
    const startBgCtx = startBgCanvas.getContext('2d');

    // Modificado para hacer el canvas del juego adaptable
    let gameCanvasWidth = 800;
    let gameCanvasHeight = 600;

    let initialWidth = window.innerWidth;
    let initialHeight = window.innerHeight;

    if (initialWidth < gameCanvasWidth) {
        gameCanvasWidth = initialWidth * 0.95;
        gameCanvasHeight = (initialWidth * 0.95) * (600 / 800);
    }
    
    canvas.width = gameCanvasWidth;
    canvas.height = gameCanvasHeight;

    startBgCanvas.width = window.innerWidth;
    startBgCanvas.height = window.innerHeight;

    const PLAYER_SPEED = 5;
    const ENEMY_SPEED = 2.5;
    const DEMO_TIME = 60;
    const INVINCIBILITY_DURATION = 2000;

    let player = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        width: 44,
        height: 44,
        dx: 0,
        dy: 0,
        lives: 3,
        isInvincible: false
    };

    let enemy = {
        x: 100,
        y: 100,
        width: 44,
        height: 44
    };

    let timer = DEMO_TIME;
    let timerInterval;
    let isPlaying = false;
    let isPaused = false;
    let isMusicPlaying = false;
    let lastHitTime = 0;
    let lastPlayerBlink = 0;
    const BLINK_INTERVAL = 100;

    const images = {};
    const imagePaths = {
        cleip: 'cleip.png',
        enemigo: 'enemigo.png',
        heart: 'corazon.png',
        // Se añadieron las dos imágenes de los cleips para los archivos cargados
        jos_seti: 'jos_seti.png',
        jo_setito: 'jo_setito.png'
    };

    let imagesLoaded = 0;
    const totalImages = Object.keys(imagePaths).length;

    let backgroundCleips = [];
    const NUM_BACKGROUND_CLEIPS = 50;
    let animationFrame;

    function loadImages() {
        for (const key in imagePaths) {
            images[key] = new Image();
            images[key].onload = () => {
                imagesLoaded++;
                if (imagesLoaded === totalImages) {
                    initBackgroundCleips();
                    animateStartScreen();
                }
            };
            images[key].src = imagePaths[key];
        }
    }

    function initBackgroundCleips() {
        if (!images.cleip) return;
        backgroundCleips = [];
        for (let i = 0; i < NUM_BACKGROUND_CLEIPS; i++) {
            backgroundCleips.push({
                x: Math.random() * startBgCanvas.width,
                y: Math.random() * startBgCanvas.height,
                size: 20 + Math.random() * 40,
                speed: 0.2 + Math.random() * 0.5,
                angle: Math.random() * 2 * Math.PI, // Ángulo inicial de rotación
                rotationSpeed: (Math.random() - 0.5) * 0.02 // Velocidad de rotación
            });
        }
    }

    function animateStartScreen() {
        startBgCtx.fillStyle = '#1a1a1a';
        startBgCtx.fillRect(0, 0, startBgCanvas.width, startBgCanvas.height);

        if (images.cleip) {
            backgroundCleips.forEach(cleip => {
                cleip.x -= cleip.speed;
                if (cleip.x + cleip.size < 0) {
                    cleip.x = startBgCanvas.width;
                    cleip.y = Math.random() * startBgCanvas.height;
                }
                
                // Actualiza el ángulo de rotación
                cleip.angle += cleip.rotationSpeed;
                
                startBgCtx.save();
                startBgCtx.translate(cleip.x + cleip.size / 2, cleip.y + cleip.size / 2);
                startBgCtx.rotate(cleip.angle);
                startBgCtx.drawImage(images.cleip, -cleip.size / 2, -cleip.size / 2, cleip.size, cleip.size);
                startBgCtx.restore();
            });
        }
        animationFrame = requestAnimationFrame(animateStartScreen);
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#1a1a1a";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (player.isInvincible) {
            if (Date.now() - lastPlayerBlink > BLINK_INTERVAL) {
                lastPlayerBlink = Date.now();
            }
            if (Math.floor(Date.now() / BLINK_INTERVAL) % 2 === 0) {
                ctx.drawImage(images.cleip, player.x, player.y, player.width, player.height);
            }
        } else {
            ctx.drawImage(images.cleip, player.x, player.y, player.width, player.height);
        }

        if (images.enemigo) {
            ctx.drawImage(images.enemigo, enemy.x, enemy.y, enemy.width, enemy.height);
        }

        if (images.heart) {
            for (let i = 0; i < player.lives; i++) {
                ctx.drawImage(images.heart, 10 + i * 35, canvas.height - 40, 30, 30);
            }
        }

        ctx.fillStyle = "#ffffff";
        ctx.font = "20px PixelatedFont";
        ctx.textAlign = "right";
        ctx.fillText(`Tiempo: ${timer}s`, canvas.width - 10, canvas.height - 20);
    }

    function update() {
        if (!isPlaying || isPaused) return;

        player.x += player.dx;
        player.y += player.dy;

        if (player.x < 0) player.x = 0;
        if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
        if (player.y < 0) player.y = 0;
        if (player.y + player.height > canvas.height) player.y = canvas.height - player.height;

        let angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
        enemy.x += Math.cos(angle) * ENEMY_SPEED;
        enemy.y += Math.sin(angle) * ENEMY_SPEED;

        const currentTime = Date.now();
        if (!player.isInvincible && currentTime - lastHitTime > INVINCIBILITY_DURATION) {
            const distance = Math.sqrt(Math.pow(player.x - enemy.x, 2) + Math.pow(player.y - enemy.y, 2));
            if (distance < (player.width + enemy.width) / 2) {
                player.lives--;
                player.isInvincible = true;
                lastHitTime = currentTime;
                setTimeout(() => {
                    player.isInvincible = false;
                }, INVINCIBILITY_DURATION);
                
                enemy.x = Math.random() * (canvas.width - enemy.width);
                enemy.y = Math.random() * (canvas.height - enemy.height);

                if (player.lives <= 0) {
                    endGame("¡JUEGO TERMINADO! Te quedaste sin vidas.");
                }
            }
        }

        draw();
        animationFrame = requestAnimationFrame(update);
    }

    function startGame() {
        startScreen.style.display = 'none';
        gameContainer.style.display = 'flex'; // Cambiado a flex para centrar el canvas
        canvas.style.display = 'block';
        
        player.lives = 3;
        player.x = canvas.width / 2;
        player.y = canvas.height / 2;
        enemy.x = Math.random() * (canvas.width - enemy.width);
        enemy.y = Math.random() * (canvas.height - enemy.height);

        tutorialMessage.style.display = 'flex';
    }

    function startActualGame() {
        isPlaying = true;
        isPaused = false;
        pauseScreen.style.display = 'none';
        endScreen.style.display = 'none';
        tutorialMessage.style.display = 'none';

        if (isMusicPlaying) {
            music.play().catch(e => console.log("La música no se pudo reproducir."));
        }

        timer = DEMO_TIME;
        timerInterval = setInterval(() => {
            if (!isPaused) {
                timer--;
                if (timer <= 0) {
                    endGame("¡FELICIDADES! Lograste sobrevivir 60 segundos.");
                }
            }
        }, 1000);

        animationFrame = requestAnimationFrame(update);
    }

    function endGame(message) {
        clearInterval(timerInterval);
        isPlaying = false;
        music.pause();
        endScreen.style.display = 'flex';
        document.getElementById('end-message').textContent = message;
    }

    function returnToStartScreen() {
        cancelAnimationFrame(animationFrame);
        clearInterval(timerInterval);
        isPlaying = false;
        
        if (isMusicPlaying) {
            music.play();
        }

        endScreen.style.display = 'none';
        gameContainer.style.display = 'none';
        startScreen.style.display = 'flex';
        initBackgroundCleips();
        animateStartScreen();
    }

    function togglePause() {
        isPaused = !isPaused;
        if (isPaused) {
            pauseScreen.style.display = 'flex';
            music.pause();
        } else {
            pauseScreen.style.display = 'none';
            if (isMusicPlaying) {
                music.play();
            }
            animationFrame = requestAnimationFrame(update);
        }
    }

    document.addEventListener('keydown', e => {
        if (!isPlaying || isPaused) {
            if (e.key === 'p' || e.key === 'P') {
                togglePause();
            }
            return;
        }
        switch(e.key.toLowerCase()) {
            case 'w':
                player.dy = -PLAYER_SPEED;
                break;
            case 's':
                player.dy = PLAYER_SPEED;
                break;
            case 'a':
                player.dx = -PLAYER_SPEED;
                break;
            case 'd':
                player.dx = PLAYER_SPEED;
                break;
            case 'p':
                togglePause();
                break;
        }
    });

    document.addEventListener('keyup', e => {
        if (!isPlaying || isPaused) return;
        switch(e.key.toLowerCase()) {
            case 'w':
            case 's':
                player.dy = 0;
                break;
            case 'a':
            case 'd':
                player.dx = 0;
                break;
        }
    });
    
    playButton.addEventListener('click', () => {
        if (imagesLoaded === totalImages) {
            startGame();
        } else {
            alert("Cargando imágenes... Por favor, espera un momento.");
        }
    });

    tutorialOkButton.addEventListener('click', () => {
        startActualGame();
    });

    // Se modificó para corregir el bug y reiniciar el juego correctamente
    endPlayAgainButton.addEventListener('click', () => {
        startGame();
    });

    endExitButton.addEventListener('click', () => {
        returnToStartScreen();
    });

    resumeButton.addEventListener('click', () => {
        togglePause();
    });

    exitPauseButton.addEventListener('click', () => {
        returnToStartScreen();
    });

    musicToggleButton.addEventListener('click', () => {
        isMusicPlaying = !isMusicPlaying;
        if (isMusicPlaying) {
            musicToggleButton.textContent = 'MÚSICA: ON';
            music.play().catch(e => console.log("La música no se pudo reproducir."));
        } else {
            musicToggleButton.textContent = 'MÚSICA: OFF';
            music.pause();
        }
    });
    
    window.addEventListener('resize', () => {
        startBgCanvas.width = window.innerWidth;
        startBgCanvas.height = window.innerHeight;
        // Ajusta el tamaño del canvas del juego al redimensionar la ventana
        let newWidth = window.innerWidth;
        if (newWidth < 800) {
            canvas.width = newWidth * 0.95;
            canvas.height = (newWidth * 0.95) * (600 / 800);
        } else {
            canvas.width = 800;
            canvas.height = 600;
        }
        // Reposiciona al jugador en el centro del nuevo canvas
        player.x = canvas.width / 2;
        player.y = canvas.height / 2;
    });

    loadImages();
</script>

</body>
</html>