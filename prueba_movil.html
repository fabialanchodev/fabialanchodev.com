<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>¡CLEIP ESCAPA! Demo Celular</title>
    <link rel="icon" type="image/png" href="cleip_milo.png">
    <style>
        @font-face {
            font-family: 'PixelatedFont';
            src: url('fuente_8bit.ttf') format('truetype');
        }

        body {
            font-family: 'PixelatedFont', sans-serif;
            background-color: #0d0d0d;
            color: #ffffff;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            text-align: center;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: none;
            flex-grow: 1;
            justify-content: center;
            align-items: center;
        }

        #game-canvas {
            border: 2px solid #ffffff;
            background-color: #1a1a1a;
            max-width: 100vw;
            max-height: 100vh;
            display: none;
        }

        .screen {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
            background-color: #1a1a1a;
            font-size: 1em;
        }
        
        #start-screen { display: flex; }
        #logo { width: 200px; height: auto; margin-bottom: 20px; z-index: 2; }
        h2 { font-size: 1.8em; color: #ffcc00; z-index: 2; }

        .game-button {
            background-color: transparent;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            margin-top: 20px;
            font-family: 'PixelatedFont', sans-serif;
            z-index: 2;
        }
        .game-button:active { border-color: #00bfff; color: #00bfff; }

        #end-screen, #pause-screen {
            background-color: rgba(0, 0, 0, 0.7);
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
        }
        #end-screen h3, #pause-screen h3 { font-size: 2em; margin-bottom: 20px; }
        #end-screen p { font-size: 1em; margin-bottom: 30px; }
        #end-screen button, #pause-screen button { margin: 10px; }

        #tutorial {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #fff; padding: 20px; border-radius: 10px; z-index: 5;
            font-size: 1.2em; display: none; flex-direction: column;
            align-items: center; justify-content: center; width: 80%;
        }
        #tutorial-text { margin-bottom: 20px; }

        /* Estilos para controles táctiles */
        #joystick-container {
            position: fixed;
            bottom: 30px;   /* Cambio: Posición fija abajo */
            left: 30px;     /* Cambio: Posición fija a la izquierda */
            width: 120px;
            height: 120px;
            z-index: 20;
            display: none;
        }
        #joystick-base {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #joystick-handle {
            position: absolute;
            width: 50%;
            height: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #pause-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: rgba(128, 128, 128, 0.5);
            border: 2px solid white;
            border-radius: 5px;
            z-index: 20;
            color: white;
            font-size: 30px;
            line-height: 45px;
            display: none;
        }
    </style>
</head>
<body>

<audio id="background-music" loop>
    <source src="cleip_escapa_soundtrack.mp3" type="audio/mpeg">
</audio>

<div id="start-screen" class="screen">
    <canvas id="start-background-canvas" style="position: absolute; top: 0; left: 0; z-index: 1;"></canvas>
    <img id="logo" src="fabi_alancho_games.png" alt="Logo">
    <h2>¡CLEIP ESCAPA!</h2>
    <p>Demo para Celular</p>
    <button id="play-button" class="game-button">JUGAR</button>
    <button id="music-toggle-button" class="game-button">MÚSICA: OFF</button>
</div>

<div id="game-container">
    <canvas id="game-canvas"></canvas>
    
    <div id="joystick-container">
        <img id="joystick-base" src="jos_seti.png">
        <img id="joystick-handle" src="jo_setito.png">
    </div>
    <button id="pause-button">II</button>

    <div id="tutorial">
        <span id="tutorial-text">Usa el joystick para moverte. Sobrevive 60 segundos. ¡Suerte!</span>
        <button id="tutorial-ok-btn" class="game-button">OK</button>
    </div>
    
    <div id="pause-screen" class="screen">
        <h3>PAUSA</h3>
        <button id="resume-button" class="game-button">REANUDAR</button>
        <button id="exit-pause-button" class="game-button">SALIR</button>
    </div>
</div>

<div id="end-screen" class="screen">
    <h3 id="end-message"></h3>
    <p>¡Descarga la versión completa!</p>
    <button id="end-play-again-button" class="game-button">REINTENTAR</button>
    <button id="end-exit-button" class="game-button">SALIR</button>
</div>

<script>
    // Referencias a elementos del DOM
    const startScreen = document.getElementById('start-screen'), endScreen = document.getElementById('end-screen');
    const pauseScreen = document.getElementById('pause-screen'), playButton = document.getElementById('play-button');
    const endPlayAgainButton = document.getElementById('end-play-again-button'), endExitButton = document.getElementById('end-exit-button');
    const resumeButton = document.getElementById('resume-button'), exitPauseButton = document.getElementById('exit-pause-button');
    const musicToggleButton = document.getElementById('music-toggle-button'), music = document.getElementById('background-music');
    const gameContainer = document.getElementById('game-container'), canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d'), tutorialMessage = document.getElementById('tutorial');
    const tutorialOkButton = document.getElementById('tutorial-ok-btn');
    const startBgCanvas = document.getElementById('start-background-canvas'), startBgCtx = startBgCanvas.getContext('2d');
    const pauseButton = document.getElementById('pause-button');
    const joystick = document.getElementById('joystick-container'), handle = document.getElementById('joystick-handle');


    // Configuración del Canvas (Mantenemos el mapa grande)
    function resizeCanvas() {
        const aspectRatio = 4 / 3;
        let newWidth = window.innerWidth;
        let newHeight = newWidth / aspectRatio;

        if (newHeight > window.innerHeight) {
            newHeight = window.innerHeight;
            newWidth = newHeight * aspectRatio;
        }
        
        canvas.width = newWidth;
        canvas.height = newHeight;
        startBgCanvas.width = window.innerWidth;
        startBgCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Constantes del juego
    const PLAYER_SPEED = 4;
    const ENEMY_SPEED = 2;
    const DEMO_TIME = 60;
    const INVINCIBILITY_DURATION = 2000;
    const BLINK_INTERVAL = 100;

    // Estado del juego
    let player = {}, enemy = {};
    let timer = DEMO_TIME;
    let timerInterval, isPlaying = false, isPaused = false, isMusicPlaying = false;
    let lastHitTime = 0, lastPlayerBlink = 0;

    // Carga de imágenes
    const images = {}, imagePaths = { cleip: 'cleip.png', enemigo: 'enemigo.png', heart: 'corazon.png' };
    let imagesLoaded = 0, totalImages = Object.keys(imagePaths).length;
    let animationFrame;

    function loadImages() {
        for (const key in imagePaths) {
            images[key] = new Image();
            images[key].onload = () => { if (++imagesLoaded === totalImages) { initBackgroundCleips(); animateStartScreen(); }};
            images[key].src = imagePaths[key];
        }
    }

    // Animación del menú
    let backgroundCleips = [];
    function initBackgroundCleips() {
        backgroundCleips = [];
        for (let i = 0; i < 50; i++) {
            backgroundCleips.push({
                x: Math.random() * startBgCanvas.width, y: Math.random() * startBgCanvas.height,
                size: 20 + Math.random() * 40, speed: 0.2 + Math.random() * 0.5,
                angle: Math.random() * 2 * Math.PI, rotationSpeed: (Math.random() - 0.5) * 0.02
            });
        }
    }
    function animateStartScreen() {
        startBgCtx.fillStyle = '#1a1a1a';
        startBgCtx.fillRect(0, 0, startBgCanvas.width, startBgCanvas.height);
        backgroundCleips.forEach(c => {
            c.x -= c.speed;
            if (c.x + c.size < 0) { c.x = startBgCanvas.width; c.y = Math.random() * startBgCanvas.height; }
            c.angle += c.rotationSpeed;
            startBgCtx.save();
            startBgCtx.translate(c.x + c.size / 2, c.y + c.size / 2);
            startBgCtx.rotate(c.angle);
            if (images.cleip) startBgCtx.drawImage(images.cleip, -c.size / 2, -c.size / 2, c.size, c.size);
            startBgCtx.restore();
        });
        animationFrame = requestAnimationFrame(animateStartScreen);
    }

    // Lógica principal del juego
    function draw() {
        ctx.fillStyle = "#1a1a1a"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        if (player.isInvincible) {
            if (Date.now() - lastPlayerBlink > BLINK_INTERVAL) {
                lastPlayerBlink = Date.now();
                if (Math.floor(Date.now() / BLINK_INTERVAL) % 2 === 0) ctx.drawImage(images.cleip, player.x, player.y, player.width, player.height);
            }
        } else ctx.drawImage(images.cleip, player.x, player.y, player.width, player.height);
        
        ctx.drawImage(images.enemigo, enemy.x, enemy.y, enemy.width, enemy.height);
        
        for (let i = 0; i < player.lives; i++) ctx.drawImage(images.heart, 10 + i * 35, 10, 30, 30);
        
        ctx.fillStyle = "#ffffff"; ctx.font = "20px PixelatedFont"; ctx.textAlign = "right";
        ctx.fillText(`Tiempo: ${timer}s`, canvas.width - 10, 30);
    }

    function update() {
        if (!isPlaying || isPaused) return;
        player.x += player.dx; player.y += player.dy;

        if (player.x < 0) player.x = 0;
        if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
        if (player.y < 0) player.y = 0;
        if (player.y + player.height > canvas.height) player.y = canvas.height - player.height;

        let angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
        enemy.x += Math.cos(angle) * ENEMY_SPEED; enemy.y += Math.sin(angle) * ENEMY_SPEED;

        const currentTime = Date.now();
        if (!player.isInvincible && currentTime - lastHitTime > INVINCIBILITY_DURATION) {
            const distance = Math.sqrt(Math.pow(player.x - enemy.x, 2) + Math.pow(player.y - enemy.y, 2));
            if (distance < (player.width + enemy.width) / 2.5) {
                player.lives--; player.isInvincible = true; lastHitTime = currentTime;
                setTimeout(() => player.isInvincible = false, INVINCIBILITY_DURATION);
                enemy.x = Math.random() * (canvas.width - enemy.width); enemy.y = Math.random() * (canvas.height - enemy.height);
                if (player.lives <= 0) endGame("¡PERDISTE!");
            }
        }
        draw();
        animationFrame = requestAnimationFrame(update);
    }

    // Funciones de estado del juego (Start, End, Pause)
    function startGame() {
        startScreen.style.display = 'none';
        endScreen.style.display = 'none';
        gameContainer.style.display = 'flex';
        canvas.style.display = 'block';
        pauseButton.style.display = 'block';
        joystick.style.display = 'block'; // Cambio: Mostrar joystick fijo
        
        player = { x: canvas.width / 2, y: canvas.height / 2, width: 44, height: 44, dx: 0, dy: 0, lives: 3, isInvincible: false };
        enemy = { x: 100, y: 100, width: 44, height: 44 };
        
        tutorialMessage.style.display = 'flex';
    }

    function startActualGame() {
        isPlaying = true; isPaused = false;
        pauseScreen.style.display = 'none'; endScreen.style.display = 'none'; tutorialMessage.style.display = 'none';
        
        if (isMusicPlaying) music.play().catch(e => {});
        
        timer = DEMO_TIME;
        timerInterval = setInterval(() => {
            if (!isPaused && isPlaying) {
                if (--timer <= 0) endGame("¡GANASTE!");
            }
        }, 1000);
        
        animationFrame = requestAnimationFrame(update);
    }

    function endGame(message) {
        clearInterval(timerInterval); isPlaying = false; music.pause();
        joystick.style.display = 'none'; // Cambio: Ocultar joystick
        pauseButton.style.display = 'none';
        endScreen.style.display = 'flex'; document.getElementById('end-message').textContent = message;
    }

    function returnToStartScreen() {
        cancelAnimationFrame(animationFrame); clearInterval(timerInterval); isPlaying = false;
        if (isMusicPlaying) music.play();
        joystick.style.display = 'none'; // Cambio: Ocultar joystick
        pauseButton.style.display = 'none';
        endScreen.style.display = 'none'; gameContainer.style.display = 'none'; startScreen.style.display = 'flex';
        initBackgroundCleips(); animateStartScreen();
    }

    function togglePause() {
        isPaused = !isPaused;
        if (isPaused) { 
            pauseScreen.style.display = 'flex'; 
            music.pause();
            joystick.style.display = 'none'; // Cambio: Ocultar en pausa
        } 
        else {
            pauseScreen.style.display = 'none';
            if (isMusicPlaying) music.play();
            joystick.style.display = 'block'; // Cambio: Mostrar al reanudar
            animationFrame = requestAnimationFrame(update);
        }
    }

    // Cambio: Lógica del Joystick Fijo
    let joystickActive = false, joystickStartX = 0, joystickStartY = 0;
    const maxJoystickMove = joystick.offsetWidth / 4;

    joystick.addEventListener('touchstart', e => {
        e.preventDefault();
        joystickActive = true;
        const touch = e.changedTouches[0];
        joystickStartX = touch.clientX;
        joystickStartY = touch.clientY;
    });

    joystick.addEventListener('touchmove', e => {
        e.preventDefault();
        if (!joystickActive) return;
        const touch = e.changedTouches[0];
        let diffX = touch.clientX - joystickStartX;
        let diffY = touch.clientY - joystickStartY;
        let angle = Math.atan2(diffY, diffX);
        let distance = Math.min(maxJoystickMove, Math.sqrt(diffX*diffX + diffY*diffY));
        
        let moveX = distance * Math.cos(angle);
        let moveY = distance * Math.sin(angle);
        handle.style.transform = `translate(-50%, -50%) translate(${moveX}px, ${moveY}px)`;

        // Normalizar el movimiento para una velocidad constante
        const normalizedDx = Math.cos(angle) * (distance / maxJoystickMove);
        const normalizedDy = Math.sin(angle) * (distance / maxJoystickMove);
        
        player.dx = normalizedDx * PLAYER_SPEED;
        player.dy = normalizedDy * PLAYER_SPEED;
    });

    joystick.addEventListener('touchend', e => {
        e.preventDefault();
        if (!joystickActive) return;
        
        joystickActive = false;
        player.dx = 0; player.dy = 0;
        
        handle.style.transform = 'translate(-50%, -50%)';
    });


    // Event Listeners de botones
    playButton.addEventListener('click', () => { if (imagesLoaded === totalImages) startGame(); else alert("Cargando..."); });
    tutorialOkButton.addEventListener('click', startActualGame);
    endPlayAgainButton.addEventListener('click', startGame);
    endExitButton.addEventListener('click', returnToStartScreen);
    resumeButton.addEventListener('click', togglePause);
    exitPauseButton.addEventListener('click', () => { isPaused = false; returnToStartScreen(); });
    pauseButton.addEventListener('click', togglePause);
    musicToggleButton.addEventListener('click', () => {
        isMusicPlaying = !isMusicPlaying;
        if (isMusicPlaying) { musicToggleButton.textContent = 'MÚSICA: ON'; music.play().catch(e => {}); } 
        else { musicToggleButton.textContent = 'MÚSICA: OFF'; music.pause(); }
    });

    loadImages();
</script>
</body>
</html>